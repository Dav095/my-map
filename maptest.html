<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Карта вышек</title>
  <script src="https://api-maps.yandex.ru/2.1/?apikey=de02242b-76ee-4ff3-8037-2fa11763d6bc&lang=ru_RU" type="text/javascript"></script>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .balloon-content {
      font-family: Arial, sans-serif;
      font-size: 14px;
      max-width: 300px;
    }
    .balloon-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #1a73e8;
    }
    .balloon-field {
      margin-bottom: 3px;
    }
    .balloon-btn {
      margin-top: 8px;
      padding: 6px 10px;
      font-size: 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 3px;
      display: inline-block;
      text-align: center;
      width: 100%;
    }
    .balloon-btn.copy {
      background-color: #2196F3;
    }
    .balloon-btn.route {
      background-color: #FF5722;
    }
    .temporary-message {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .control-panel {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 5px;
      z-index: 999;
      font-family: Arial, sans-serif;
      width: 200px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: transform 0.3s ease;
    }
    .control-panel.collapsed {
      transform: translateX(-85%);
      width: 30px;
      overflow: hidden;
    }
    .control-panel.collapsed h3,
    .control-panel.collapsed input,
    .control-panel.collapsed button {
      display: none;
    }
    .toggle-panel {
      position: absolute;
      right: -30px;
      top: 0;
      width: 30px;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 0 5px 5px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .control-panel h3 {
      margin: 0 0 8px 0;
      font-size: 14px;
    }
    .control-panel input[type="text"] {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px;
      font-size: 12px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    .control-panel button {
      width: 100%;
      padding: 6px;
      font-size: 12px;
      background-color: #1a73e8;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 3px;
    }
    .control-panel button:hover {
      background-color: #0d5bba;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div class="control-panel">
    <div class="toggle-panel" onclick="toggleControlPanel()">≡</div>
    <h3>Добавить точку</h3>
    <input type="text" id="userCoords" placeholder="Формат: N55.6816 E37.5162">
    <button id="addPointBtn">Добавить</button>
  </div>

  <script>
    let myMap;
    let placemarks = [];
    let userPlacemark = null;

    ymaps.ready(init);

    function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const dataParam = urlParams.get('data') || urlParams.get('d');
      let towerData = [];
      
      if (dataParam) {
        try {
          const parsedData = JSON.parse(decodeURIComponent(dataParam));
          
          if (parsedData.t && Array.isArray(parsedData.p)) {
            towerData = parsedData.p.map(point => ({
              coords: point.c || [0, 0],
              source: point.s || (point.t === 'o2r' ? 'O2R' : 'Неизвестно'),
              radius: point.r || null,
              type: 'regular',
              imei: point.i || '',
              vehicleName: point.v || '',
              vehicleNumber: point.n || '',
              taskType: point.t === 'o2r' ? 'o2r' : '',
              gpsInView: point.g || ''
            }));
          } else if (Array.isArray(parsedData)) {
            towerData = parsedData;
          }
        } catch (e) {
          console.error("Ошибка при парсинге данных:", e);
          showTemporaryMessage('Ошибка при загрузке данных карты.');
        }
      }

      const defaultCenter = [55.755864, 37.617698];
      const firstPoint = towerData.length > 0 ? towerData[0].coords : defaultCenter;

      myMap = new ymaps.Map("map", {
        center: firstPoint,
        zoom: 12,
        controls: ['zoomControl', 'fullscreenControl']
      });

      // Обрабатываем каждую точку данных
      towerData.forEach(point => {
        if (!point.coords || point.coords.length !== 2) return;
        
        const coords = point.coords;
        const sourceStr = point.source || '';
        const isO2R = point.taskType && point.taskType.toLowerCase() === 'o2r';

        // Определяем тип и цвет метки
        let isBlock = sourceStr.includes("Блок");
        let isTower = sourceStr.includes("Яндекс") || sourceStr.includes("Кэш");
        let preset = 'islands#blueCircleIcon'; // По умолчанию для блоков

        if (isTower) preset = 'islands#redCircleIcon';
        if (isO2R) preset = 'islands#greenCircleIcon';

        // Формируем содержимое балуна
        let balloonContent = `
          <div class="balloon-content">
            <div class="balloon-title">${escapeHtml(sourceStr)}</div>
            
            ${point.vehicleName ? `
              <div class="balloon-field">
                <b>Авто:</b> ${escapeHtml(point.vehicleName)}
              </div>
            ` : ''}
            
            ${point.vehicleNumber ? `
              <div class="balloon-field">
                <b>Номер:</b> ${escapeHtml(point.vehicleNumber)}
              </div>
            ` : ''}
            
            <div class="balloon-field">
              <b>Координаты:</b> ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}
            </div>
            
            ${point.imei ? `
              <div class="balloon-field">
                <b>IMEI:</b> ${escapeHtml(point.imei)}
              </div>
            ` : ''}
            
            <button class="balloon-btn copy" onclick="copyToClipboard('${coords[0]}, ${coords[1]}')">
              Скопировать координаты
            </button>
            
            <button class="balloon-btn route" onclick="buildRoute(${coords[0]}, ${coords[1]})">
              Построить маршрут
            </button>
          </div>
        `;

        // Создаем метку
        const placemark = new ymaps.Placemark(
          coords,
          {
            hintContent: escapeHtml(sourceStr),
            balloonContent: balloonContent
          },
          { 
            preset: preset,
            hideIconOnBalloonOpen: false
          }
        );

        myMap.geoObjects.add(placemark);
      });

      // Настройка элементов управления
      setupControls();
    }

    function setupControls() {
      const userCoordsInput = document.getElementById('userCoords');
      const addPointBtn = document.getElementById('addPointBtn');

      // Добавление пользовательской точки
      addPointBtn.addEventListener('click', addUserPoint);

      // Обработчик нажатия Enter в поле ввода координат
      userCoordsInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addUserPoint();
        }
      });
    }

    function addUserPoint() {
      const coordsText = document.getElementById('userCoords').value.trim();
      if (!coordsText) {
        showTemporaryMessage('Введите координаты');
        return;
      }

      const coords = parseCoordinates(coordsText);
      if (!coords) {
        showTemporaryMessage('Неверный формат координат. Пример: N55.6816 E37.5162');
        return;
      }

      // Удаляем предыдущую пользовательскую метку
      if (userPlacemark) {
        myMap.geoObjects.remove(userPlacemark);
      }

      // Создаем новую метку
      userPlacemark = new ymaps.Placemark(
        coords,
        {
          hintContent: 'Ваша точка',
          balloonContent: `
            <div class="balloon-content">
              <div class="balloon-title">Ваша точка</div>
              <div class="balloon-field">
                <b>Координаты:</b> ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}
              </div>
              <button class="balloon-btn copy" onclick="copyToClipboard('${coords[0]}, ${coords[1]}')">
                Скопировать координаты
              </button>
            </div>
          `
        },
        {
          preset: 'islands#violetIcon',
          draggable: true
        }
      );

      myMap.geoObjects.add(userPlacemark);
      myMap.setCenter(coords, 15);
      document.getElementById('userCoords').value = '';
      showTemporaryMessage('Точка добавлена на карту');
    }

    function parseCoordinates(input) {
      // 1. Проверяем формат "N55.6816 E37.5162"
      let letterFormat = /^\s*([NS])\s*(\d{1,2}\.?\d*)[, ]?\s*([EW])\s*(\d{1,3}\.?\d*)\s*$/i;
      let match = input.match(letterFormat);
      if (match) {
        let lat = parseFloat(match[2]);
        let lon = parseFloat(match[4]);
        
        if (match[1].toUpperCase() === 'S') lat = -lat;
        if (match[3].toUpperCase() === 'W') lon = -lon;
        
        if (isValidCoord(lat, lon)) return [lat, lon];
      }

      // 2. Проверяем формат "55.7558, 37.6177" или "55.7558 37.6177"
      let decimalRegex = /^\s*([-+]?\d{1,2}\.?\d*)[,\s]\s*([-+]?\d{1,3}\.?\d*)\s*$/;
      match = input.match(decimalRegex);
      if (match) {
        const lat = parseFloat(match[1]);
        const lon = parseFloat(match[2]);
        if (isValidCoord(lat, lon)) return [lat, lon];
      }

      // 3. Проверяем формат градусы-минуты-секунды: 55°45'21"N 37°36'44"E
      let dmsRegex = /^\s*([-+]?\d{1,3})°\s*(\d{1,2})['′]\s*(\d{1,2}(?:\.\d+)?)?["″]?\s*([NS]?)\s*[, ]\s*([-+]?\d{1,3})°\s*(\d{1,2})['′]\s*(\d{1,2}(?:\.\d+)?)?["″]?\s*([EW]?)\s*$/i;
      match = input.match(dmsRegex);
      if (match) {
        let lat = parseDMS(match[1], match[2], match[3], match[4]);
        let lon = parseDMS(match[5], match[6], match[7], match[8]);
        if (isValidCoord(lat, lon)) return [lat, lon];
      }

      return null;
    }

    function parseDMS(deg, min, sec, dir) {
      let degrees = parseFloat(deg);
      let minutes = parseFloat(min || 0);
      let seconds = parseFloat(sec || 0);
      let decimal = degrees + minutes/60 + seconds/3600;
      
      if (dir) {
        dir = dir.toUpperCase();
        if (dir === 'S' || dir === 'W') {
          decimal = -decimal;
        }
      }
      
      return decimal;
    }

    function isValidCoord(lat, lon) {
      return lat >= -90 && lat <= 90 && lon >= -180 && lon <= 180;
    }

    window.copyToClipboard = function(text) {
      navigator.clipboard.writeText(text).then(() => {
        showTemporaryMessage('Координаты скопированы: ' + text);
      }).catch(() => {
        showTemporaryMessage('Ошибка при копировании');
      });
    };

    window.buildRoute = function(lat, lon) {
      if (/Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent)) {
        window.open(`yandexnavi://build_route_on_map?lat_to=${lat}&lon_to=${lon}`, '_blank');
      } else {
        window.open(`https://yandex.ru/maps/?ll=${lon},${lat}&z=16&mode=routes`, '_blank');
      }
    };

    window.toggleControlPanel = function() {
      const panel = document.querySelector('.control-panel');
      panel.classList.toggle('collapsed');
    };

    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function showTemporaryMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.textContent = message;
      messageDiv.className = 'temporary-message';
      document.body.appendChild(messageDiv);
      setTimeout(() => {
        document.body.removeChild(messageDiv);
      }, 3000);
    }
  </script>
</body>
</html>
