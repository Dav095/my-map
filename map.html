<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Карта вышек</title>
  <script src="https://api-maps.yandex.ru/2.1/?apikey=de02242b-76ee-4ff3-8037-2fa11763d6bc&lang=ru_RU" type="text/javascript"></script>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .balloon-content {
      font-family: Arial, sans-serif;
      font-size: 14px;
      max-width: 300px;
    }
    .balloon-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #1a73e8;
    }
    .balloon-field {
      margin-bottom: 3px;
    }
    .balloon-btn {
      margin-top: 8px;
      padding: 6px 10px;
      font-size: 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 3px;
      display: inline-block;
      text-align: center;
      width: 100%;
    }
    .balloon-btn.copy {
      background-color: #2196F3;
    }
    .balloon-btn.route {
      background-color: #FF5722;
    }
    .temporary-message {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .control-panel {
      position: fixed;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 5px;
      z-index: 999;
      font-size: 14px;
      font-family: Arial, sans-serif;
      max-width: 250px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .control-panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #1a73e8;
    }
    .control-panel label {
      display: block;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .control-panel input[type="text"],
    .control-panel input[type="number"] {
      width: 100%;
      margin-bottom: 8px;
      padding: 6px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    .control-panel button {
      width: 100%;
      padding: 8px;
      font-size: 13px;
      background-color: #1a73e8;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 3px;
      margin-bottom: 8px;
    }
    .control-panel button:hover {
      background-color: #0d5bba;
    }
    .legend {
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      margin-right: 8px;
    }
    @media (max-width: 768px) {
      .control-panel {
        max-width: 200px;
        font-size: 12px;
      }
      .balloon-content {
        font-size: 12px;
      }
      .balloon-btn {
        padding: 5px 8px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="control-panel">
    <h3>Управление картой</h3>
    <label><input type="checkbox" id="showTowers" checked> Показать вышки</label>
    <label><input type="checkbox" id="showBlocks" checked> Показать блоки</label>
    <label><input type="checkbox" id="showO2R" checked> Показать O2R</label>
    
    <div style="margin: 10px 0;">
      <input type="text" id="imeiSearch" placeholder="Поиск по IMEI">
      <button id="searchBtn">Найти</button>
    </div>
    
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background-color: #FF0000;"></div>
        <span>Вышки</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #0000FF;"></div>
        <span>Блоки</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #00AA00;"></div>
        <span>O2R</span>
      </div>
    </div>
  </div>

  <script>
    let myMap;
    let placemarks = [];
    let lines = [];
    let userPlacemarks = [];
    let o2rPlacemarks = [];

    ymaps.ready(init);

    function init() {
      const urlParams = new URLSearchParams(window.location.search);
      const dataParam = urlParams.get('data');
      let towerData = [];
      
      if (dataParam) {
        try {
          towerData = JSON.parse(decodeURIComponent(dataParam));
        } catch (e) {
          console.error("Ошибка при парсинге данных:", e);
          showTemporaryMessage('Ошибка при загрузке данных карты.');
        }
      }

      const defaultCenter = [55.755864, 37.617698];
      const firstPoint = towerData.length > 0 ? towerData[0].coords : defaultCenter;

      myMap = new ymaps.Map("map", {
        center: firstPoint,
        zoom: 12,
        controls: ['zoomControl', 'fullscreenControl']
      });

      // Определяем тип устройства
      const isMobile = /Android|iPhone|iPad|iPod|Mobile|Windows Phone/i.test(navigator.userAgent);
      if (isMobile) {
        myMap.behaviors.disable('scrollZoom');
      }

      // Обрабатываем каждую точку данных
      towerData.forEach((point, index) => {
        const coords = point.coords;
        const radius = point.radius;
        const sourceStr = point.source;
        const type = point.type || 'regular';
        const isO2R = point.taskType && point.taskType.toLowerCase() === 'o2r';

        // Определяем тип метки
        let isBlock = sourceStr.includes("Блок");
        let isTower = (sourceStr.includes("Яндекс") || sourceStr.includes("Кэш"));
        let preset = 'islands#blueCircleIcon'; // По умолчанию для блоков

        if (isTower) {
          preset = 'islands#redCircleIcon';
        } else if (isO2R) {
          preset = 'islands#greenCircleIcon';
        }

        // Создаем радиус (если указан)
        let circle = null;
        if (radius) {
          circle = new ymaps.Circle(
            [coords, radius],
            {},
            {
              fillOpacity: 0,
              strokeColor: "#0000FF",
              strokeOpacity: 0.8,
              strokeWidth: 2,
              visible: false
            }
          );
          myMap.geoObjects.add(circle);
        }

        // Формируем содержимое балуна
        let balloonContent = `
          <div class="balloon-content">
            <div class="balloon-title">${escapeHtml(sourceStr)}</div>
            
            ${point.vehicleNumber ? `
              <div class="balloon-field">
                <b>Госномер:</b> ${escapeHtml(point.vehicleNumber)}
              </div>
            ` : ''}
            
            ${point.vehicleName ? `
              <div class="balloon-field">
                <b>Авто:</b> ${escapeHtml(point.vehicleName)}
              </div>
            ` : ''}
            
            <div class="balloon-field">
              <b>Координаты:</b> ${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}
            </div>
            
            ${radius ? `
              <div class="balloon-field">
                <b>Радиус:</b> ${radius} м
              </div>
            ` : ''}
            
            ${point.gpsInView ? `
              <div class="balloon-field">
                <b>Спутники:</b> ${point.gpsInView}
              </div>
            ` : ''}
            
            <button class="balloon-btn copy" onclick="copyToClipboard('${coords[0]}, ${coords[1]}')">
              Скопировать координаты
            </button>
            
            <button class="balloon-btn route" onclick="buildRoute(${coords[0]}, ${coords[1]})">
              Построить маршрут
            </button>
            
            ${radius ? `
              <button class="balloon-btn" onclick="toggleRadius(${index})">
                ${circle.options.get('visible') ? 'Скрыть радиус' : 'Показать радиус'}
              </button>
            ` : ''}
          </div>
        `;

        // Создаем метку
        const placemark = new ymaps.Placemark(
          coords,
          {
            hintContent: escapeHtml(sourceStr),
            balloonContent: balloonContent
          },
          { 
            preset: preset,
            hideIconOnBalloonOpen: false
          }
        );

        // Связываем метку с радиусом
        if (circle) {
          placemark.radiusCircle = circle;
        }

        myMap.geoObjects.add(placemark);

        // Сохраняем метку в соответствующем массиве
        const placemarkObj = {
          placemark,
          type: isO2R ? 'o2r' : (isTower ? 'tower' : 'block'),
          imei: point.imei,
          index
        };

        placemarks.push(placemarkObj);
        
        if (isO2R) {
          o2rPlacemarks.push(placemarkObj);
        }
      });

      // Настройка фильтров
      const showTowers = document.getElementById('showTowers');
      const showBlocks = document.getElementById('showBlocks');
      const showO2R = document.getElementById('showO2R');
      const imeiSearch = document.getElementById('imeiSearch');
      const searchBtn = document.getElementById('searchBtn');

      function updateVisibility() {
        const towersVisible = showTowers.checked;
        const blocksVisible = showBlocks.checked;
        const o2rVisible = showO2R.checked;

        placemarks.forEach(p => {
          let visible = true;
          
          if (p.type === 'tower' && !towersVisible) visible = false;
          if (p.type === 'block' && !blocksVisible) visible = false;
          if (p.type === 'o2r' && !o2rVisible) visible = false;
          
          p.placemark.options.set('visible', visible);
          
          // Скрываем/показываем радиусы
          if (p.placemark.radiusCircle) {
            p.placemark.radiusCircle.options.set('visible', visible && p.placemark.radiusCircle.options.get('visible'));
          }
        });
      }

      showTowers.addEventListener('change', updateVisibility);
      showBlocks.addEventListener('change', updateVisibility);
      showO2R.addEventListener('change', updateVisibility);

      // Поиск по IMEI
      searchBtn.addEventListener('click', () => {
        const searchImei = imeiSearch.value.trim();
        if (!searchImei) return;

        const found = placemarks.filter(p => p.imei === searchImei);
        if (found.length > 0) {
          // Сбрасываем все выделения
          placemarks.forEach(p => {
            if (p.type === 'tower') {
              p.placemark.options.set('preset', 'islands#redCircleIcon');
            } else if (p.type === 'block') {
              p.placemark.options.set('preset', 'islands#blueCircleIcon');
            } else if (p.type === 'o2r') {
              p.placemark.options.set('preset', 'islands#greenCircleIcon');
            }
          });

          // Выделяем найденные
          found.forEach(p => {
            p.placemark.options.set('preset', 'islands#violetCircleIcon');
          });

          // Центрируем карту
          const coords = found.map(f => f.placemark.geometry.getCoordinates());
          const bounds = ymaps.util.bounds.fromPoints(coords);
          myMap.setBounds(bounds, { checkZoomRange: true });
          
          showTemporaryMessage(`Найдено ${found.length} точек для IMEI: ${searchImei}`);
        } else {
          showTemporaryMessage(`IMEI ${searchImei} не найден!`);
        }
      });

      // Инициализация видимости
      updateVisibility();
    }

    // Глобальные функции
    window.toggleRadius = function(index) {
      const placemark = placemarks[index];
      if (placemark && placemark.placemark.radiusCircle) {
        const currentVisibility = placemark.placemark.radiusCircle.options.get('visible');
        placemark.placemark.radiusCircle.options.set('visible', !currentVisibility);
      }
    };

    window.copyToClipboard = function(text) {
      navigator.clipboard.writeText(text).then(() => {
        showTemporaryMessage('Координаты скопированы: ' + text);
      }).catch(() => {
        showTemporaryMessage('Ошибка при копировании');
      });
    };

    window.buildRoute = function(lat, lon) {
      if (/Mobi|Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent)) {
        window.open(`yandexnavi://build_route_on_map?lat_to=${lat}&lon_to=${lon}`, '_blank');
      } else {
        window.open(`https://yandex.ru/maps/?ll=${lon},${lat}&z=16&mode=routes`, '_blank');
      }
    };

    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
    }

    function showTemporaryMessage(message) {
      const messageDiv = document.createElement('div');
      messageDiv.textContent = message;
      messageDiv.className = 'temporary-message';
      document.body.appendChild(messageDiv);
      setTimeout(() => {
        document.body.removeChild(messageDiv);
      }, 3000);
    }
  </script>
</body>
</html>
